name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

# Prevent concurrent reviews on the same PR
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secrets
        run: |
          set -eu
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "::error::CLAUDE_CODE_OAUTH_TOKEN secret is not set"
            exit 1
          fi
          echo "‚úì Required secrets are configured"

      - name: Run Claude Code Review
        id: claude-review
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: 10
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Check for OpenAI API Key
        id: check-openai
        if: steps.claude-review.outcome == 'failure'
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "::warning::OPENAI_API_KEY secret is not configured. Skipping OpenAI fallback."
          fi

      - name: Fallback to OpenAI GPT 5.2-codex Code Review
        id: openai-review
        if: steps.claude-review.outcome == 'failure' && steps.check-openai.outputs.has_key == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîÑ Claude review failed, falling back to OpenAI GPT 5.2-codex..."
          
          # Get PR diff
          PR_DIFF=$(gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }})
          
          # Get PR details
          PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json title -q '.title')
          PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q '.body')
          
          # Prepare the review prompt
          REVIEW_PROMPT="You are an expert code reviewer. Review this pull request and provide feedback on:
          - Code quality and best practices
          - Potential bugs or issues
          - Performance considerations
          - Security concerns
          - Test coverage
          
          PR Title: $PR_TITLE
          
          PR Description: $PR_BODY
          
          Code Changes (diff):
          $PR_DIFF
          
          Please provide a comprehensive code review with specific, actionable feedback. Format your response in Markdown."
          
          # Call OpenAI API using GPT 5.2-codex
          REVIEW_RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$(jq -n \
              --arg prompt "$REVIEW_PROMPT" \
              '{
                model: "gpt-5.2-codex",
                messages: [
                  {role: "system", content: "You are an expert code reviewer providing constructive feedback on pull requests."},
                  {role: "user", content: $prompt}
                ],
                temperature: 0.3,
                max_tokens: 4096
              }')" | jq -r '.choices[0].message.content // "Error: Failed to get response from OpenAI API"')
          
          # Post comment to PR
          COMMENT_BODY="## ü§ñ OpenAI GPT 5.2-codex Code Review
          
          > _Note: This review was generated by OpenAI GPT 5.2-codex as a fallback because Claude Code Review encountered an issue._
          
          $REVIEW_RESPONSE"
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "$COMMENT_BODY"
          
          echo "‚úÖ OpenAI code review completed successfully"

      - name: Report failure
        if: steps.claude-review.outcome == 'failure' && steps.openai-review.outcome != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è Code Review encountered an error. Both Claude and OpenAI GPT 5.2-codex reviews failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

